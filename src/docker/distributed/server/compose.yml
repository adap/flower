services:
  superlink:
    image: flwr/superlink:${FLWR_VERSION:-1.10.0}
    command:
      - --insecure
    ports:
      - 9092:9092

  superexec:
    build:
      context: ${PROJECT_DIR:-.}
      dockerfile_inline: |
        FROM flwr/superexec:${FLWR_VERSION:-1.10.0}

        WORKDIR /app
        COPY --chown=app:app pyproject.toml .
        RUN sed -i 's/.*flwr\[simulation\].*//' pyproject.toml \
          && python -m pip install -U --no-cache-dir .

        RUN --mount=type=bind,target=./$PROJECT_DIR \
          flwr build --directory $PROJECT_DIR \
          && flwr install flower.quickstart-docker-compose.1-0-0.fab \
          && rm flower.quickstart-docker-compose.1-0-0.fab

        ENTRYPOINT ["flower-superexec"]
    command:
      - --executor
      - flwr.superexec.deployment:executor
      - --insecure
      - --executor-config
      - superlink="superlink:9091"
    ports:
      - 9093:9093
    depends_on:
      - superlink
