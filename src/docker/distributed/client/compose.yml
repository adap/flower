x-supernode: &supernode
  deploy:
    resources:
      limits:
        cpus: "2"
  command:
    - --superlink
    - ${SUPERLINK_ADDRESS:-localhost:9092}
    - --insecure

services:
  supernode-1:
    <<: *supernode
    build:
      context: ${PROJECT_DIR:-.}
      dockerfile_inline: |
        FROM flwr/supernode:1.10.0.dev20240721

        WORKDIR /app
        COPY --chown=app:app pyproject.toml .
        RUN sed -i 's/.*flwr\[simulation\].*//' pyproject.toml \
          && python -m pip install -U --no-cache-dir .

        ENTRYPOINT ["flower-supernode", "client:app", "--node-config", "partition-id=0,num-partitions=2"]

  supernode-2:
    <<: *supernode
    build:
      context: ${PROJECT_DIR:-.}
      dockerfile_inline: |
        FROM flwr/supernode:1.10.0.dev20240721

        WORKDIR /app
        COPY --chown=app:app pyproject.toml .
        RUN sed -i 's/.*flwr\[simulation\].*//' pyproject.toml \
          && python -m pip install -U --no-cache-dir .

        ENTRYPOINT ["flower-supernode", "client:app", "--node-config", "partition-id=1,num-partitions=2"]
